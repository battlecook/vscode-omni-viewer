/*! For license information please see audioViewer.js.LICENSE.txt */
var AudioViewer;(()=>{"use strict";var e={formatTime:function(e){var t=Math.floor(e/60),n=Math.floor(e%60),r=Math.floor(e%1*1e3);return"".concat(t,":").concat(n.toString().padStart(2,"0"),".").concat(r.toString().padStart(3,"0"))},showStatus:function(e,t){t&&(t.textContent=e,t.classList.add("show"),setTimeout(function(){t.classList.remove("show")},100))},log:function(e){"undefined"!=typeof vscode&&vscode.env&&1===vscode.env.uiKind&&console.log(e)}};function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function n(){var e,t,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.toStringTag||"@@toStringTag";function s(n,o,a,i){var s=o&&o.prototype instanceof u?o:u,c=Object.create(s.prototype);return r(c,"_invoke",function(n,r,o){var a,i,s,u=0,c=o||[],f=!1,d={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(t,n){return a=t,i=0,s=e,d.n=n,l}};function g(n,r){for(i=n,s=r,t=0;!f&&u&&!o&&t<c.length;t++){var o,a=c[t],g=d.p,p=a[2];n>3?(o=p===r)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=g&&((o=n<2&&g<a[1])?(i=0,d.v=r,d.n=a[1]):g<p&&(o=n<3||a[0]>r||r>p)&&(a[4]=n,a[5]=r,d.n=p,i=0))}if(o||n>1)return l;throw f=!0,r}return function(o,c,p){if(u>1)throw TypeError("Generator is already running");for(f&&1===c&&g(c,p),i=c,s=p;(t=i<2?e:s)||!f;){a||(i?i<3?(i>1&&(d.n=-1),g(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(f=d.n<0)?s:n.call(r,d))!==l)break}catch(t){a=e,i=1,s=t}finally{u=1}}return{value:t,done:f}}}(n,a,i),!0),c}var l={};function u(){}function c(){}function f(){}t=Object.getPrototypeOf;var d=[][a]?t(t([][a]())):(r(t={},a,function(){return this}),t),g=f.prototype=u.prototype=Object.create(d);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,r(e,i,"GeneratorFunction")),e.prototype=Object.create(g),e}return c.prototype=f,r(g,"constructor",f),r(f,"constructor",c),c.displayName="GeneratorFunction",r(f,i,"GeneratorFunction"),r(g),r(g,i,"Generator"),r(g,a,function(){return this}),r(g,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m:p}})()}function r(e,t,n,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}r=function(e,t,n,o){function i(t,n){r(e,t,function(e){return this._invoke(t,n,e)})}t?a?a(e,t,{value:n,enumerable:!o,configurable:!o,writable:!o}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},r(e,t,n,o)}function o(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,i(r.key),r)}}function i(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}var s=function(){return t=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t},r=[{key:"initialize",value:(i=n().m(function t(){var r,o,a;return n().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!this.state.audioContextInitialized){t.n=1;break}return t.a(2);case 1:if(t.p=1,"suspended"!==(r=new(window.AudioContext||window.webkitAudioContext)).state){t.n=2;break}return t.n=2,r.resume();case 2:this.state.audioContextInitialized=!0,t.n=4;break;case 3:t.p=3,a=t.v,console.error("Failed to initialize AudioContext:",a),e.showStatus("AudioContext initialization failed: "+a.message,null===(o=this.state.elements)||void 0===o?void 0:o.status);case 4:return t.a(2)}},t,this,[[1,3]])}),s=function(){var e=this,t=arguments;return new Promise(function(n,r){var a=i.apply(e,t);function s(e){o(a,n,r,s,l,"next",e)}function l(e){o(a,n,r,s,l,"throw",e)}s(void 0)})},function(){return s.apply(this,arguments)})},{key:"getWaveSurferAudioContext",value:function(){try{var e;return null!==(e=this.state.wavesurfer)&&void 0!==e&&null!==(e=e.backend)&&void 0!==e&&e.audioContext?this.state.wavesurfer.backend.audioContext:null}catch(e){return console.error("Error getting WaveSurfer AudioContext:",e),null}}},{key:"checkState",value:function(){var e=this.getWaveSurferAudioContext();return e?e.state:null}}],r&&a(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,r,i,s}(),l={WAVESURFER:{WAVE_COLOR:"#4F4A85",PROGRESS_COLOR:"#383351",CURSOR_COLOR:"#fff",BAR_WIDTH:2,BAR_RADIUS:3,CURSOR_WIDTH:1,BAR_GAP:3,SAMPLE_RATE:44100},TIMELINE:{MIN_TICK_PIXELS:100,NICE_STEPS:[.5,1,2,5,10,15,30,60,120,300,600,900,1800,3600]},SPECTROGRAM:{FFT_SIZE:4096,NOVERLAP:2048,HEIGHT:250,SCALE_OPTIONS:[{value:"linear",label:"Linear"},{value:"mel",label:"Mel"},{value:"bark",label:"Bark"},{value:"erb",label:"ERB"}],DEFAULT_SCALE:"mel"},REGION:{MIN_DURATION:.1}};function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,d(r.key),r)}}function d(e){var t=function(e){if("object"!=u(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=u(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==u(t)?t:t+""}var g=function(){return t=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t},(n=[{key:"create",value:function(){return WaveSurfer.create({container:"#waveform",waveColor:l.WAVESURFER.WAVE_COLOR,progressColor:l.WAVESURFER.PROGRESS_COLOR,cursorColor:l.WAVESURFER.CURSOR_COLOR,barWidth:l.WAVESURFER.BAR_WIDTH,barRadius:l.WAVESURFER.BAR_RADIUS,cursorWidth:l.WAVESURFER.CURSOR_WIDTH,barGap:l.WAVESURFER.BAR_GAP,responsive:!0,sampleRate:l.WAVESURFER.SAMPLE_RATE,normalize:!0,backend:"WebAudio",autoplay:!1,mediaControls:!1,hideScrollbar:!1,interact:!0,plugins:[WaveSurfer.Hover.create({lineWidth:2,labelBackground:"#000000",labelColor:"#fff",formatTimeCallback:e.formatTime})]})}},{key:"getTimelineIntervals",value:function(e){if(!e||e<=0)return{timeInterval:1,primaryLabelInterval:5,secondaryLabelInterval:1};var t,n=document.getElementById("timeline"),r=((null==n?void 0:n.offsetWidth)||1e3)/e,o=l.TIMELINE.NICE_STEPS[l.TIMELINE.NICE_STEPS.length-1],a=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return c(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw a}}}}(l.TIMELINE.NICE_STEPS);try{for(a.s();!(t=a.n()).done;){var i=t.value;if(i*r>=l.TIMELINE.MIN_TICK_PIXELS){o=i;break}}}catch(e){a.e(e)}finally{a.f()}return{timeInterval:o,primaryLabelInterval:5*o,secondaryLabelInterval:o}}}])&&f(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n}();function p(e){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p(e)}function v(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var l=r&&r.prototype instanceof s?r:s,u=Object.create(l.prototype);return m(u,"_invoke",function(n,r,o){var a,s,l,u=0,c=o||[],f=!1,d={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(t,n){return a=t,s=0,l=e,d.n=n,i}};function g(n,r){for(s=n,l=r,t=0;!f&&u&&!o&&t<c.length;t++){var o,a=c[t],g=d.p,p=a[2];n>3?(o=p===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=g&&((o=n<2&&g<a[1])?(s=0,d.v=r,d.n=a[1]):g<p&&(o=n<3||a[0]>r||r>p)&&(a[4]=n,a[5]=r,d.n=p,s=0))}if(o||n>1)return i;throw f=!0,r}return function(o,c,p){if(u>1)throw TypeError("Generator is already running");for(f&&1===c&&g(c,p),s=c,l=p;(t=s<2?e:l)||!f;){a||(s?s<3?(s>1&&(d.n=-1),g(s,l)):d.n=l:d.v=l);try{if(u=2,a){if(s||(o="next"),t=a[o]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((t=(f=d.n<0)?l:n.call(r,d))!==i)break}catch(t){a=e,s=1,l=t}finally{u=1}}return{value:t,done:f}}}(n,o,a),!0),u}var i={};function s(){}function l(){}function u(){}t=Object.getPrototypeOf;var c=[][r]?t(t([][r]())):(m(t={},r,function(){return this}),t),f=u.prototype=s.prototype=Object.create(c);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,m(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=u,m(f,"constructor",u),m(u,"constructor",l),l.displayName="GeneratorFunction",m(u,o,"GeneratorFunction"),m(f),m(f,o,"Generator"),m(f,r,function(){return this}),m(f,"toString",function(){return"[object Generator]"}),(v=function(){return{w:a,m:d}})()}function m(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}m=function(e,t,n,r){function a(t,n){m(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},m(e,t,n,r)}function y(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function h(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){y(a,r,o,i,s,"next",e)}function s(e){y(a,r,o,i,s,"throw",e)}i(void 0)})}}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,w(r.key),r)}}function w(e){var t=function(e){if("object"!=p(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==p(t)?t:t+""}var S=function(){return t=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t,this.waveSurferManager=n},n=[{key:"setupSpectrogram",value:(i=h(v().m(function t(){var n;return v().w(function(t){for(;;)switch(t.n){case 0:if(this.state.spectrogramPlugin)try{this.state.wavesurfer.unregisterPlugin(this.state.spectrogramPlugin),this.state.spectrogramPlugin=null}catch(e){console.warn("Error removing existing spectrogram plugin:",e)}(n=document.getElementById("spectrogram"))&&(n.innerHTML="");try{this.state.spectrogramPlugin=this.state.wavesurfer.registerPlugin(WaveSurfer.Spectrogram.create({container:"#spectrogram",labels:!0,scale:l.SPECTROGRAM.DEFAULT_SCALE,splitChannels:!1,fftSize:l.SPECTROGRAM.FFT_SIZE,noverlap:l.SPECTROGRAM.NOVERLAP,height:l.SPECTROGRAM.HEIGHT})),e.log("Spectrogram plugin registered successfully")}catch(e){console.warn("Failed to register spectrogram plugin:",e),this.state.spectrogramPlugin=null}case 1:return t.a(2)}},t,this)})),function(){return i.apply(this,arguments)})},{key:"changeSpectrogramScale",value:(a=h(v().m(function t(n){var r,o=this;return v().w(function(t){for(;;)switch(t.n){case 0:if(this.state.spectrogramPlugin){t.n=1;break}return console.warn("Spectrogram plugin not available"),t.a(2);case 1:try{this.state.wavesurfer.unregisterPlugin(this.state.spectrogramPlugin),this.state.spectrogramPlugin=null,(r=document.getElementById("spectrogram"))&&(r.innerHTML=""),this.state.spectrogramPlugin=this.state.wavesurfer.registerPlugin(WaveSurfer.Spectrogram.create({container:"#spectrogram",labels:!0,scale:n,splitChannels:!1,fftSize:l.SPECTROGRAM.FFT_SIZE,noverlap:l.SPECTROGRAM.NOVERLAP,height:l.SPECTROGRAM.HEIGHT})),setTimeout(function(){o.state.spectrogramPlugin&&o.state.spectrogramPlugin.render()},100),e.log("Spectrogram scale changed to: ".concat(n))}catch(e){console.warn("Failed to change spectrogram scale:",e)}case 2:return t.a(2)}},t,this)})),function(e){return a.apply(this,arguments)})},{key:"setupTimeline",value:(o=h(v().m(function t(){var n,r;return v().w(function(t){for(;;)switch(t.n){case 0:if(this.state.timelinePlugin)try{this.state.wavesurfer.unregisterPlugin(this.state.timelinePlugin),this.state.timelinePlugin=null}catch(e){console.warn("Error removing existing timeline plugin:",e)}(n=document.getElementById("timeline"))&&(n.innerHTML=""),r=this.waveSurferManager.getTimelineIntervals(this.state.wavesurfer.getDuration());try{this.state.timelinePlugin=this.state.wavesurfer.registerPlugin(WaveSurfer.Timeline.create({container:"#timeline",formatTimeCallback:e.formatTime,timeInterval:r.timeInterval,primaryLabelInterval:r.primaryLabelInterval,secondaryLabelInterval:r.secondaryLabelInterval})),e.log("Timeline plugin registered successfully")}catch(e){console.warn("Failed to register timeline plugin:",e),this.state.timelinePlugin=null}case 1:return t.a(2)}},t,this)})),function(){return o.apply(this,arguments)})},{key:"setupRegions",value:(r=h(v().m(function t(){var n;return v().w(function(t){for(;;)switch(t.p=t.n){case 0:t.p=0,this.state.regionsPlugin=this.state.wavesurfer.registerPlugin(WaveSurfer.Regions.create({})),e.log("Regions plugin registered successfully"),t.n=2;break;case 1:return t.p=1,n=t.v,console.warn("Failed to register regions plugin:",n),this.state.regionsPlugin=null,t.a(2);case 2:this.setupRegionEvents();case 3:return t.a(2)}},t,this,[[0,1]])})),function(){return r.apply(this,arguments)})},{key:"setupRegionEvents",value:function(){var e=this;this.state.regionsPlugin.enableDragSelection({color:"rgba(255, 0, 0, 0.1)"}),this.state.regionsPlugin.on("region-created",function(t){e.state.regionsPlugin.getRegions&&e.state.regionsPlugin.getRegions().forEach(function(e){e.id!==t.id&&e.remove()}),e.state.selectedRegionId=t.id,e.state.regionManager.showControls(),setTimeout(function(){e.state.regionManager.createOverlays(t)},100)}),this.state.regionsPlugin.on("region-clicked",function(t){e.state.selectedRegionId=t.id,e.state.regionManager.showControls(),e.state.regionManager.createOverlays(t)}),this.state.regionsPlugin.on("region-removed",function(t){e.state.selectedRegionId===t.id&&(e.state.selectedRegionId=null,e.state.regionManager.hideControls())}),this.state.regionsPlugin.on("region-updated",function(t){e.state.selectedRegionId===t.id&&e.state.regionManager.updateOverlays(t)}),this.setupRegionClickHandlers()}},{key:"setupRegionClickHandlers",value:function(){var e=this,t=function(){var t;if(null!==(t=e.state.regionsPlugin)&&void 0!==t&&t.getRegions){var n=e.state.regionsPlugin.getRegions();n&&Object.keys(n).length>0&&(Object.values(n).forEach(function(e){e.remove()}),e.state.selectedRegionId=null,e.state.regionManager.hideControls())}};document.getElementById("waveform").addEventListener("click",function(e){var n=e.target;n.closest(".wavesurfer-region")||n.closest(".region-input-overlay")||n.classList.contains("region-input-overlay")||n.classList.contains("region-start-input")||n.classList.contains("region-end-input")||t()});var n=document.getElementById("spectrogram");n&&n.addEventListener("click",t)}}],n&&b(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,a,i}();function E(e){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E(e)}function P(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,O(r.key),r)}}function O(e){var t=function(e){if("object"!=E(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=E(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==E(t)?t:t+""}var I=function(){return t=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t},n=[{key:"showControls",value:function(){this.state.elements.loopControls.style.display="flex"}},{key:"hideControls",value:function(){this.state.elements.loopControls.style.display="none",this.removeOverlays()}},{key:"createOverlays",value:function(e){this.removeOverlays();var t=document.getElementById("waveform"),n=t.getBoundingClientRect(),r=e.element;if(r){var o=r.getBoundingClientRect();this.state.regionStartOverlay=document.createElement("div"),this.state.regionStartOverlay.className="region-input-overlay",this.state.regionStartOverlay.innerHTML='\n            <input type="number" value="'.concat(e.start.toFixed(3),'" class="region-start-input" title="Start time">\n        '),this.state.regionEndOverlay=document.createElement("div"),this.state.regionEndOverlay.className="region-input-overlay",this.state.regionEndOverlay.innerHTML='\n            <input type="number" value="'.concat(e.end.toFixed(3),'" class="region-end-input" title="End time">\n        ');var a=o.left-n.left-10,i=o.right-n.left+10,s=o.top-n.top+10;this.state.regionStartOverlay.style.left=a+"px",this.state.regionStartOverlay.style.top=s+"px",this.state.regionEndOverlay.style.left=i+"px",this.state.regionEndOverlay.style.top=s+"px",t.appendChild(this.state.regionStartOverlay),t.appendChild(this.state.regionEndOverlay),this.setupOverlayEvents(e)}}},{key:"setupOverlayEvents",value:function(t){var n=this,r=this.state.regionStartOverlay.querySelector(".region-start-input"),o=this.state.regionEndOverlay.querySelector(".region-end-input"),a=function(r,o){if(console.log("applyRegionInput called with:",{startTimeInput:r,endTimeInput:o,region:t}),t&&n.state.wavesurfer){var a=n.state.wavesurfer.getDuration()||0,i=t.start,s=t.end,u=parseFloat(r),c=parseFloat(o);if(isNaN(u)||(i=u),isNaN(c)||(s=c),i>s){var f=i;i=s,s=f}i>a&&(i=Math.max(0,a-l.REGION.MIN_DURATION)),s>a&&(s=a),i=Math.max(0,i),s=Math.min(a,s),i+l.REGION.MIN_DURATION>s&&(s=Math.min(a,i+l.REGION.MIN_DURATION));try{if(n.state.regionsPlugin&&n.state.regionsPlugin.getRegions){var d=n.state.regionsPlugin.getRegions();Object.values(d).forEach(function(e){e.remove()})}if(n.state.regionsPlugin&&n.state.regionsPlugin.addRegion){var g=n.state.regionsPlugin.addRegion({start:i,end:s,color:"rgba(255, 0, 0, 0.1)"});n.state.selectedRegionId=g.id,setTimeout(function(){n.createOverlays(g)},100)}}catch(t){console.error("Failed to update region: ",t),e.showStatus("Failed to update region: "+t.message,n.state.elements.status)}}},i=function(e){var t=e.target.value,n=o.value;a(t,n)},s=function(e){var t=r.value,n=e.target.value;a(t,n)};r.addEventListener("change",i),r.addEventListener("keydown",function(e){"Enter"===e.key&&(e.target.blur(),i(e))}),o.addEventListener("change",s),o.addEventListener("keydown",function(e){"Enter"===e.key&&(e.target.blur(),s(e))})}},{key:"updateOverlays",value:function(e){if(this.state.regionStartOverlay&&this.state.regionEndOverlay){var t=this.state.regionStartOverlay.querySelector(".region-start-input"),n=this.state.regionEndOverlay.querySelector(".region-end-input");t.value=e.start.toFixed(3),n.value=e.end.toFixed(3)}}},{key:"removeOverlays",value:function(){this.state.regionStartOverlay&&(this.state.regionStartOverlay.remove(),this.state.regionStartOverlay=null),this.state.regionEndOverlay&&(this.state.regionEndOverlay.remove(),this.state.regionEndOverlay=null)}},{key:"getSelectedRegion",value:function(){var e;if(null===(e=this.state.regionsPlugin)||void 0===e||!e.getRegions)return null;var t=this.state.regionsPlugin.getRegions();if(!t||0===Object.keys(t).length)return null;if(this.state.selectedRegionId&&t[this.state.selectedRegionId])return t[this.state.selectedRegionId];var n=Object.keys(t);if(n.length>0){var r=t[n[n.length-1]];return this.state.selectedRegionId=r.id,r}return null}},{key:"clearAllRegions",value:function(){var e;if(this.state.wavesurfer&&this.state.isPlaying&&(this.state.wavesurfer.stop(),this.state.isPlaying=!1,this.state.elements.playPause&&(this.state.elements.playPause.textContent="▶️",this.state.elements.playPause.classList.remove("playing"))),null!==(e=this.state.regionsPlugin)&&void 0!==e&&e.getRegions){var t=this.state.regionsPlugin.getRegions();t&&Object.keys(t).length>0&&Object.values(t).forEach(function(e){e.remove()})}this.state.selectedRegionId=null,this.removeOverlays(),this.hideControls(),console.log("All regions cleared and audio stopped")}},{key:"clearRegionsFromDOM",value:function(){this.state.wavesurfer&&this.state.isPlaying&&(this.state.wavesurfer.stop(),this.state.isPlaying=!1,this.state.elements.playPause&&(this.state.elements.playPause.textContent="▶️",this.state.elements.playPause.classList.remove("playing")));var e=document.getElementById("waveform");e&&e.querySelectorAll(".wavesurfer-region").forEach(function(e){return e.remove()}),this.state.selectedRegionId=null,this.removeOverlays(),this.hideControls(),console.log("Regions cleared from DOM and audio stopped")}}],n&&P(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n}();function R(e){return R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},R(e)}function M(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],l=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,o=e}finally{try{if(!l&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return k(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function C(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,T(r.key),r)}}function T(e){var t=function(e){if("object"!=R(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=R(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==R(t)?t:t+""}var A=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t,this.audioMetadata=n},t=[{key:"updateDuration",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(e||(e=this.state.wavesurfer.getDuration()),e&&!isNaN(e)){var t=Math.floor(e/60),n=Math.floor(e%60);this.state.elements.durationInfo.textContent="".concat(t,":").concat(n.toString().padStart(2,"0"))}}},{key:"updateFileInfo",value:function(){try{var e=this.state.wavesurfer.getDecodedData(),t=this.audioMetadata.sampleRate||(null==e?void 0:e.sampleRate)||l.WAVESURFER.SAMPLE_RATE,n=this.audioMetadata.channels||(null==e?void 0:e.numberOfChannels)||2,r=this.audioMetadata.bitDepth||((null==e?void 0:e.length)>0?e instanceof Float32Array?32:16:"--"),o=this.audioMetadata.format||this.detectFormat(),a=this.audioMetadata.fileSize||(e?this.estimateFileSize(e):"--"),i=this.audioMetadata.duration||(e?e.length/t:"--");this.state.elements.sampleRateInfo.textContent=t?"".concat(t," Hz"):"--",this.state.elements.channelsInfo.textContent=n||"--",this.state.elements.bitDepthInfo.textContent="--"===r?"--":"".concat(r," bit"),this.state.elements.formatInfo.textContent=o||"--",this.state.elements.fileSizeInfo.textContent=a||"--",i&&"--"!==i?this.updateDuration(i):this.updateDuration(),this.state.elements.fileInfo.style.display="flex"}catch(e){console.warn("Error updating file info:",e)}}},{key:"estimateFileSize",value:function(e){if(!e)return"--";var t=e.length*e.numberOfChannels*2,n=Math.round(t/1024),r=(t/1048576).toFixed(1);return r>1?"".concat(r," MB"):"".concat(n," KB")}},{key:"detectFormat",value:function(){var e="{{audioSrc}}";if(!e.startsWith("data:")){var t,n=null===(t=e.split(".").pop())||void 0===t?void 0:t.toLowerCase();return{mp3:"MP3",wav:"WAV",flac:"FLAC",ogg:"OGG",aac:"AAC",webm:"WEBM"}[n]||(null==n?void 0:n.toUpperCase())||"Unknown"}var r=e.match(/data:([^;]+)/);if(r){for(var o,a=r[1],i=0,s=Object.entries({mpeg:"MP3",mp3:"MP3",wav:"WAV",flac:"FLAC",ogg:"OGG",aac:"AAC",webm:"WEBM"});i<s.length;i++){var l=M(s[i],2),u=l[0],c=l[1];if(a.includes(u))return c}return(null===(o=a.split("/")[1])||void 0===o?void 0:o.toUpperCase())||"Unknown"}return"Unknown"}}],t&&C(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function x(e){return x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},x(e)}function L(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var l=r&&r.prototype instanceof s?r:s,u=Object.create(l.prototype);return F(u,"_invoke",function(n,r,o){var a,s,l,u=0,c=o||[],f=!1,d={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(t,n){return a=t,s=0,l=e,d.n=n,i}};function g(n,r){for(s=n,l=r,t=0;!f&&u&&!o&&t<c.length;t++){var o,a=c[t],g=d.p,p=a[2];n>3?(o=p===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=g&&((o=n<2&&g<a[1])?(s=0,d.v=r,d.n=a[1]):g<p&&(o=n<3||a[0]>r||r>p)&&(a[4]=n,a[5]=r,d.n=p,s=0))}if(o||n>1)return i;throw f=!0,r}return function(o,c,p){if(u>1)throw TypeError("Generator is already running");for(f&&1===c&&g(c,p),s=c,l=p;(t=s<2?e:l)||!f;){a||(s?s<3?(s>1&&(d.n=-1),g(s,l)):d.n=l:d.v=l);try{if(u=2,a){if(s||(o="next"),t=a[o]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((t=(f=d.n<0)?l:n.call(r,d))!==i)break}catch(t){a=e,s=1,l=t}finally{u=1}}return{value:t,done:f}}}(n,o,a),!0),u}var i={};function s(){}function l(){}function u(){}t=Object.getPrototypeOf;var c=[][r]?t(t([][r]())):(F(t={},r,function(){return this}),t),f=u.prototype=s.prototype=Object.create(c);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,F(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=u,F(f,"constructor",u),F(u,"constructor",l),l.displayName="GeneratorFunction",F(u,o,"GeneratorFunction"),F(f),F(f,o,"Generator"),F(f,r,function(){return this}),F(f,"toString",function(){return"[object Generator]"}),(L=function(){return{w:a,m:d}})()}function F(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}F=function(e,t,n,r){function a(t,n){F(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},F(e,t,n,r)}function j(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function _(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){j(a,r,o,i,s,"next",e)}function s(e){j(a,r,o,i,s,"throw",e)}i(void 0)})}}function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,B(r.key),r)}}function B(e){var t=function(e){if("object"!=x(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=x(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==x(t)?t:t+""}var D=function(){return t=function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.state=t,this.audioContextManager=n,this.regionManager=r},n=[{key:"setupPlayPause",value:function(){var t=this;this.state.elements.playPause.addEventListener("click",_(L().m(function n(){var r,o,a;return L().w(function(n){for(;;)switch(n.p=n.n){case 0:if(console.log("Play/Pause button clicked, current state:",t.state.isPlaying),n.p=1,!t.state.isPlaying){n.n=2;break}t.state.wavesurfer.pause(),n.n=8;break;case 2:if(t.state.wavesurfer){n.n=3;break}return n.a(2);case 3:if(t.state.audioContextInitialized){n.n=4;break}return n.n=4,t.audioContextManager.initialize();case 4:if("suspended"!==(null==(r=t.audioContextManager.getWaveSurferAudioContext())?void 0:r.state)){n.n=5;break}return n.n=5,r.resume();case 5:if(!(o=t.regionManager.getSelectedRegion())){n.n=7;break}return n.n=6,t.state.wavesurfer.play(o.start,o.end);case 6:n.n=8;break;case 7:return n.n=8,t.state.wavesurfer.play();case 8:n.n=10;break;case 9:if(n.p=9,a=n.v,console.error("Playback error:",a),e.showStatus("Playback error: "+a.message,t.state.elements.status),!a.message.includes("AudioContext")&&!a.message.includes("suspended")){n.n=10;break}return t.state.audioContextInitialized=!1,n.n=10,t.audioContextManager.initialize();case 10:return n.a(2)}},n,null,[[1,9]])})))}},{key:"setupStop",value:function(){var e=this;this.state.elements.stop.addEventListener("click",function(){e.state.wavesurfer.stop()})}},{key:"setupVolume",value:function(){var e=this;this.state.elements.volume.addEventListener("input",function(t){var n=parseFloat(t.target.value);e.state.wavesurfer.setVolume(n)})}},{key:"setupLoop",value:function(){var e=this;this.state.elements.loopEnabled.addEventListener("change",function(t){e.state.loopEnabled=t.target.checked})}},{key:"setupSpectrogramScale",value:function(){var e=this;this.state.elements.spectrogramScale&&this.state.elements.spectrogramScale.addEventListener("change",function(){var t=_(L().m(function t(n){var r;return L().w(function(t){for(;;)switch(t.n){case 0:if(r=n.target.value,console.log("Spectrogram scale changed to:",r),!e.state.pluginManager){t.n=1;break}return t.n=1,e.state.pluginManager.changeSpectrogramScale(r);case 1:return t.a(2)}},t)}));return function(e){return t.apply(this,arguments)}}())}},{key:"setupKeyboardEvents",value:function(){var t=this;document.addEventListener("keydown",function(){var n=_(L().m(function n(r){var o,a,i;return L().w(function(n){for(;;)switch(n.p=n.n){case 0:if("Space"!==r.code||r.target.matches("input, textarea")){n.n=9;break}if(console.log("Space key detected, triggering play/pause"),r.preventDefault(),t.state.audioContextInitialized){n.n=4;break}return n.p=1,n.n=2,t.audioContextManager.initialize();case 2:n.n=4;break;case 3:return n.p=3,a=n.v,console.error("AudioContext initialization failed on spacebar:",a),e.showStatus("AudioContext initialization failed: "+a.message,t.state.elements.status),n.a(2);case 4:if("suspended"!==(null==(o=t.audioContextManager.getWaveSurferAudioContext())?void 0:o.state)){n.n=8;break}return n.p=5,n.n=6,o.resume();case 6:n.n=8;break;case 7:return n.p=7,i=n.v,console.error("Failed to resume AudioContext on spacebar:",i),e.showStatus("Failed to resume AudioContext: "+i.message,t.state.elements.status),n.a(2);case 8:t.state.elements.playPause.click();case 9:return n.a(2)}},n,null,[[5,7],[1,3]])}));return function(e){return n.apply(this,arguments)}}())}},{key:"setupWaveSurferEvents",value:function(){var t=this;this.state.wavesurfer.on("play",function(){console.log("WaveSurfer play event triggered"),t.state.isPlaying=!0,t.state.elements.playPause.textContent="⏸️",t.state.elements.playPause.classList.add("playing"),console.log("Button text changed to pause icon")}),this.state.wavesurfer.on("pause",function(){console.log("WaveSurfer pause event triggered"),t.state.isPlaying=!1,t.state.elements.playPause.textContent="▶️",t.state.elements.playPause.classList.remove("playing"),console.log("Button text changed to play icon")}),this.state.wavesurfer.on("stop",function(){console.log("WaveSurfer stop event triggered"),t.state.isPlaying=!1,t.state.elements.playPause.textContent="▶️",t.state.elements.playPause.classList.remove("playing"),console.log("Button text changed to play icon")}),this.state.wavesurfer.on("finish",function(){if(t.state.loopEnabled){var e=t.regionManager.getSelectedRegion();e?setTimeout(function(){t.state.wavesurfer.play(e.start,e.end)},100):setTimeout(function(){t.state.wavesurfer.play()},100)}else t.state.isPlaying=!1,t.state.elements.playPause.textContent="▶️",t.state.elements.playPause.classList.remove("playing")});var n=null;this.state.wavesurfer.on("play",function(){t.state.loopEnabled&&(n=setInterval(function(){if(t.state.isPlaying&&t.state.loopEnabled){var e=t.state.wavesurfer.getCurrentTime(),n=t.regionManager.getSelectedRegion();n&&void 0!==n.start&&void 0!==n.end?e>=n.end-.1&&t.state.wavesurfer.play(n.start,n.end):e>=t.state.wavesurfer.getDuration()-.1&&t.state.wavesurfer.play()}},100))}),this.state.wavesurfer.on("pause",function(){n&&(clearInterval(n),n=null)}),this.state.wavesurfer.on("stop",function(){n&&(clearInterval(n),n=null)}),this.state.wavesurfer.on("error",function(n){e.showStatus("Error: "+n.message,t.state.elements.status),vscode.postMessage({command:"error",text:n.message})}),this.state.wavesurfer.on("ready",function(){setTimeout(function(){t.audioContextManager.checkState()},100)}),this.state.wavesurfer.on("decode",function(){setTimeout(function(){t.state.fileInfoManager.updateFileInfo()},100)})}}],n&&N(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n}();function G(e){return G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},G(e)}function U(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var l=r&&r.prototype instanceof s?r:s,u=Object.create(l.prototype);return W(u,"_invoke",function(n,r,o){var a,s,l,u=0,c=o||[],f=!1,d={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(t,n){return a=t,s=0,l=e,d.n=n,i}};function g(n,r){for(s=n,l=r,t=0;!f&&u&&!o&&t<c.length;t++){var o,a=c[t],g=d.p,p=a[2];n>3?(o=p===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=g&&((o=n<2&&g<a[1])?(s=0,d.v=r,d.n=a[1]):g<p&&(o=n<3||a[0]>r||r>p)&&(a[4]=n,a[5]=r,d.n=p,s=0))}if(o||n>1)return i;throw f=!0,r}return function(o,c,p){if(u>1)throw TypeError("Generator is already running");for(f&&1===c&&g(c,p),s=c,l=p;(t=s<2?e:l)||!f;){a||(s?s<3?(s>1&&(d.n=-1),g(s,l)):d.n=l:d.v=l);try{if(u=2,a){if(s||(o="next"),t=a[o]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((t=(f=d.n<0)?l:n.call(r,d))!==i)break}catch(t){a=e,s=1,l=t}finally{u=1}}return{value:t,done:f}}}(n,o,a),!0),u}var i={};function s(){}function l(){}function u(){}t=Object.getPrototypeOf;var c=[][r]?t(t([][r]())):(W(t={},r,function(){return this}),t),f=u.prototype=s.prototype=Object.create(c);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,W(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=u,W(f,"constructor",u),W(u,"constructor",l),l.displayName="GeneratorFunction",W(u,o,"GeneratorFunction"),W(f),W(f,o,"Generator"),W(f,r,function(){return this}),W(f,"toString",function(){return"[object Generator]"}),(U=function(){return{w:a,m:d}})()}function W(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}W=function(e,t,n,r){function a(t,n){W(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},W(e,t,n,r)}function z(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function V(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){z(a,r,o,i,s,"next",e)}function s(e){z(a,r,o,i,s,"throw",e)}i(void 0)})}}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,q(r.key),r)}}function q(e){var t=function(e){if("object"!=G(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=G(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==G(t)?t:t+""}var K=function(){return t=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.vscode=acquireVsCodeApi(),this.audioSrc="{{audioSrc}}",this.audioMetadata=function(){try{var e=document.getElementById("metadata-script");if(e&&e.textContent)return JSON.parse(e.textContent)}catch(e){console.warn("Error parsing metadata:",e)}return{}}(),this.state={wavesurfer:null,spectrogramPlugin:null,timelinePlugin:null,regionsPlugin:null,isPlaying:!1,loopEnabled:!1,isSetupComplete:!1,audioContextInitialized:!1,selectedRegionId:null,regionStartOverlay:null,regionEndOverlay:null,elements:{playPause:document.getElementById("playPause"),stop:document.getElementById("stop"),volume:document.getElementById("volume"),loopEnabled:document.getElementById("loopEnabled"),loopControls:document.getElementById("loopControls"),spectrogramScale:document.getElementById("spectrogramScale"),loading:document.getElementById("loading"),error:document.getElementById("error"),waveform:document.getElementById("waveform"),spectrogram:document.getElementById("spectrogram"),status:document.getElementById("status"),fileInfo:document.getElementById("fileInfo"),durationInfo:document.getElementById("durationInfo"),sampleRateInfo:document.getElementById("sampleRateInfo"),channelsInfo:document.getElementById("channelsInfo"),bitDepthInfo:document.getElementById("bitDepthInfo"),fileSizeInfo:document.getElementById("fileSizeInfo"),formatInfo:document.getElementById("formatInfo"),downloadBtn:document.getElementById("downloadBtn")}},this.audioContextManager=new s(this.state),this.waveSurferManager=new g(this.state),this.regionManager=new I(this.state),this.fileInfoManager=new A(this.state,this.audioMetadata),this.pluginManager=new S(this.state,this.waveSurferManager),this.eventManager=new D(this.state,this.audioContextManager,this.regionManager),this.state.audioContextManager=this.audioContextManager,this.state.regionManager=this.regionManager,this.state.fileInfoManager=this.fileInfoManager,this.state.pluginManager=this.pluginManager,this.setupDownloadButton()},n=[{key:"initAudioViewer",value:(o=V(U().m(function t(){var n,r,o,a=this;return U().w(function(t){for(;;)switch(t.n){case 0:try{e.log("Initializing audio viewer..."),e.log("Audio source length: "+this.audioSrc.length),this.regionManager.clearRegionsFromDOM(),this.state.wavesurfer=this.waveSurferManager.create(),n=function(){var t=V(U().m(function t(){var n;return U().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,a.state.isSetupComplete=!1,a.regionManager.clearAllRegions(),t.n=1,a.state.wavesurfer.load(a.audioSrc);case 1:return t.n=2,new Promise(function(e){return setTimeout(e,100)});case 2:a.audioContextManager.checkState(),t.n=4;break;case 3:throw t.p=3,n=t.v,console.error("Error loading audio:",n),e.showStatus("Error loading audio: "+n.message,a.state.elements.status),n;case 4:return t.a(2)}},t,null,[[0,3]])}));return function(){return t.apply(this,arguments)}}(),r=function(){var t=V(U().m(function t(){var r;return U().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,n();case 1:t.n=3;break;case 2:t.p=2,r=t.v,console.warn("Preload failed:",r),e.showStatus("Preload failed: "+r.message,a.state.elements.status),a.setupUserInteractionHandler();case 3:return t.a(2)}},t,null,[[0,2]])}));return function(){return t.apply(this,arguments)}}(),this.eventManager.setupKeyboardEvents(),r(),o=function(){var t=V(U().m(function t(){return U().w(function(t){for(;;)switch(t.n){case 0:if(!a.state.isSetupComplete){t.n=1;break}return t.a(2);case 1:return console.log("Setting up audio viewer after decode..."),a.state.isSetupComplete=!0,t.n=2,a.pluginManager.setupSpectrogram();case 2:return t.n=3,a.pluginManager.setupTimeline();case 3:return t.n=4,a.pluginManager.setupRegions();case 4:a.state.elements.loading.style.display="none",a.state.elements.waveform.style.display="block",a.state.elements.spectrogram.style.display="block",a.state.spectrogramPlugin&&setTimeout(function(){a.state.spectrogramPlugin.render()},100),console.log("Setting up event listeners..."),a.eventManager.setupPlayPause(),a.eventManager.setupStop(),a.eventManager.setupVolume(),a.eventManager.setupLoop(),a.eventManager.setupSpectrogramScale(),a.eventManager.setupWaveSurferEvents(),console.log("Event listeners setup complete"),a.fileInfoManager.updateDuration(),a.fileInfoManager.updateFileInfo(),setTimeout(function(){if(a.state.spectrogramPlugin)try{var t,n;e.log("Spectrogram frequency range check..."),e.log("Sample rate: "+((null===(t=a.state.wavesurfer.getDecodedData())||void 0===t?void 0:t.sampleRate)||"unknown")),e.log("FFT size: "+((null===(n=a.state.spectrogramPlugin.params)||void 0===n?void 0:n.fftSize)||"unknown"))}catch(e){console.warn("Error checking spectrogram frequency range:",e)}},1e3);case 5:return t.a(2)}},t)}));return function(){return t.apply(this,arguments)}}(),this.state.wavesurfer.on("decode",o)}catch(e){console.error("Error loading audio:",e),this.state.elements.loading.style.display="none",this.state.elements.error.style.display="block",this.state.elements.error.textContent="Error loading audio file: "+e.message,this.vscode.postMessage({command:"error",text:e.message}),"NotSupportedError"===e.name?this.state.elements.error.textContent+="\n\nThis audio format may not be supported by your browser.":"QuotaExceededError"===e.name&&(this.state.elements.error.textContent+="\n\nFile is too large. Try a smaller audio file.")}case 1:return t.a(2)}},t,this)})),function(){return o.apply(this,arguments)})},{key:"initialize",value:function(){this.regionManager.clearRegionsFromDOM(),this.regionManager.hideControls(),this.regionManager.clearAllRegions(),this.initAudioViewer(),this.vscode.postMessage({command:"log",text:"Audio viewer initialized"})}},{key:"setupDownloadButton",value:function(){var e=this;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){e.attachDownloadListener()}):this.attachDownloadListener()}},{key:"attachDownloadListener",value:function(){var t=this,n=this.state.elements.downloadBtn;n?(n.addEventListener("click",function(e){console.log("Download button clicked!",e),t.downloadAudioFile()}),e.log("Download button listener attached"),console.log("Download button found and listener attached")):(console.warn("Download button not found in DOM"),console.log("Available elements:",this.state.elements))}},{key:"downloadAudioFile",value:(r=V(U().m(function t(){var n,r,o,a,i,s,l,u,c,f,d,g,p,v;return U().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,e.log("Starting audio file download..."),console.log("Audio source:",this.audioSrc),n=this.audioSrc,r=this.extractFileNameFromUrl(n)||"audio_file",console.log("Download filename:",r),t.p=1,console.log("Trying VSCode extension method..."),this.vscode.postMessage({command:"downloadFile",url:n,fileName:r}),e.showStatus("Download requested via VSCode extension",this.state.elements.status),t.a(2);case 2:t.p=2,g=t.v,console.warn("VSCode extension method failed:",g),o=!1;try{console.log("Trying forced download method..."),(a=document.createElement("a")).href=n,a.download=r,a.style.display="none",a.setAttribute("download",r),a.download!==r&&a.setAttribute("download",r),document.body.appendChild(a),i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}),a.dispatchEvent(i),document.body.removeChild(a),o=!0,console.log("Method 1 (forced download) succeeded")}catch(e){console.warn("Method 1 failed:",e)}if(o){t.n=8;break}return t.p=3,console.log("Trying fetch + blob method..."),t.n=4,fetch(n,{method:"GET",mode:"cors",cache:"no-cache"});case 4:if((s=t.v).ok){t.n=5;break}throw new Error("HTTP error! status: ".concat(s.status));case 5:return t.n=6,s.blob();case 6:l=t.v,console.log("Blob created:",l.size,"bytes, type:",l.type),u=URL.createObjectURL(l),console.log("Blob URL created:",u),(c=document.createElement("a")).href=u,c.download=r,c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout(function(){URL.revokeObjectURL(u),console.log("Blob URL revoked")},2e3),o=!0,console.log("Method 2 (fetch + blob) succeeded"),t.n=8;break;case 7:t.p=7,p=t.v,console.warn("Method 2 failed:",p);case 8:if(!o)try{console.log("Trying in-page download method..."),(f=document.createElement("a")).href=n,f.download=r,f.textContent="Download ".concat(r),f.style.cssText="\n                        display: block;\n                        padding: 10px;\n                        margin: 10px;\n                        background: var(--vscode-button-background);\n                        color: var(--vscode-button-foreground);\n                        text-decoration: none;\n                        border-radius: 4px;\n                        text-align: center;\n                    ",(d=document.querySelector(".main-content"))&&(d.appendChild(f),setTimeout(function(){f.click(),setTimeout(function(){f.parentNode&&f.parentNode.removeChild(f)},1e3)},100),o=!0,console.log("Method 3 (in-page link) succeeded"))}catch(e){console.warn("Method 3 failed:",e)}if(!o)try{console.log("Trying new tab method..."),window.open(n,"_blank")&&(o=!0,console.log("Method 4 (new tab) succeeded"))}catch(e){console.warn("Method 4 failed:",e)}if(!o){t.n=9;break}e.log("Download initiated for: "+r),e.showStatus("Download started: "+r,this.state.elements.status),t.n=10;break;case 9:throw new Error("All download methods failed");case 10:t.n=12;break;case 11:t.p=11,v=t.v,console.error("Error downloading audio file:",v),e.showStatus("Download failed: "+v.message,this.state.elements.status);case 12:return t.a(2)}},t,this,[[3,7],[1,2],[0,11]])})),function(){return r.apply(this,arguments)})},{key:"extractFileNameFromUrl",value:function(e){try{if(console.log("Extracting filename from URL:",e),e.startsWith("data:"))return console.log("Data URL detected, using metadata filename"),this.getFileNameFromMetadata()||"audio_file";if(e.startsWith("blob:"))return console.log("Blob URL detected, using metadata filename"),this.getFileNameFromMetadata()||"audio_file";var t=new URL(e).pathname.split("/").pop();return console.log("Extracted filename from URL:",t),t&&""!==t&&t.includes(".")?t:(console.log("No valid filename in URL, using metadata"),this.getFileNameFromMetadata()||"audio_file")}catch(e){return console.warn("Error extracting filename from URL:",e),this.getFileNameFromMetadata()||"audio_file"}}},{key:"getFileNameFromMetadata",value:function(){try{if(console.log("Getting filename from metadata:",this.audioMetadata),this.audioMetadata&&this.audioMetadata.fileName)return console.log("Found filename in metadata:",this.audioMetadata.fileName),this.audioMetadata.fileName;var e=document.title;if(console.log("Document title:",e),e&&"Audio Viewer"!==e){var t=e.replace("Audio Viewer - ","");return console.log("Extracted filename from title:",t),t}var n=new URLSearchParams(window.location.search),r=n.get("fileName")||n.get("filename");return r?(console.log("Found filename in URL params:",r),r):(console.log("No filename found in metadata or title"),null)}catch(e){return console.warn("Error getting filename from metadata:",e),null}}}],n&&H(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o}();console.log("Audio viewer script loading..."),document.addEventListener("DOMContentLoaded",function(){console.log("DOM Content Loaded"),console.log("Initializing audio viewer..."),(new K).initialize()}),AudioViewer={}})();