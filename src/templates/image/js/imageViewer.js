var ImageViewer;(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}function n(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,"string");if("object"!=e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}var i=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.image=t,this.brightness=100,this.contrast=100,this.saturation=100,this.grayscale=0,this.brightnessSlider=document.getElementById("brightnessSlider"),this.contrastSlider=document.getElementById("contrastSlider"),this.saturationSlider=document.getElementById("saturationSlider"),this.grayscaleSlider=document.getElementById("grayscaleSlider"),this.presetNormal=document.getElementById("presetNormal"),this.presetBright=document.getElementById("presetBright"),this.presetDark=document.getElementById("presetDark"),this.presetVintage=document.getElementById("presetVintage"),this.presetBw=document.getElementById("presetBw")},n=[{key:"setupEventListeners",value:function(){var e=this;this.brightnessSlider.addEventListener("input",function(t){e.brightness=parseInt(t.target.value),e.updateFilters()}),this.contrastSlider.addEventListener("input",function(t){e.contrast=parseInt(t.target.value),e.updateFilters()}),this.saturationSlider.addEventListener("input",function(t){e.saturation=parseInt(t.target.value),e.updateFilters()}),this.grayscaleSlider.addEventListener("input",function(t){e.grayscale=parseInt(t.target.value),e.updateFilters()}),this.presetNormal.addEventListener("click",function(){return e.applyPreset("normal")}),this.presetBright.addEventListener("click",function(){return e.applyPreset("bright")}),this.presetDark.addEventListener("click",function(){return e.applyPreset("dark")}),this.presetVintage.addEventListener("click",function(){return e.applyPreset("vintage")}),this.presetBw.addEventListener("click",function(){return e.applyPreset("bw")})}},{key:"updateFilters",value:function(){var e="brightness(".concat(this.brightness,"%) contrast(").concat(this.contrast,"%) saturate(").concat(this.saturation,"%) grayscale(").concat(this.grayscale,"%)");this.image.style.filter=e}},{key:"getFilterString",value:function(){return"brightness(".concat(this.brightness,"%) contrast(").concat(this.contrast,"%) saturate(").concat(this.saturation,"%) grayscale(").concat(this.grayscale,"%)")}},{key:"applyPreset",value:function(e){switch(document.querySelectorAll(".preset-btn").forEach(function(e){return e.classList.remove("active")}),e){case"normal":this.brightness=100,this.contrast=100,this.saturation=100,this.grayscale=0,this.presetNormal.classList.add("active");break;case"bright":this.brightness=130,this.contrast=110,this.saturation=100,this.grayscale=0,this.presetBright.classList.add("active");break;case"dark":this.brightness=70,this.contrast=120,this.saturation=100,this.grayscale=0,this.presetDark.classList.add("active");break;case"vintage":this.brightness=110,this.contrast=90,this.saturation=70,this.grayscale=10,this.presetVintage.classList.add("active");break;case"bw":this.brightness=100,this.contrast=120,this.saturation=0,this.grayscale=100,this.presetBw.classList.add("active")}this.brightnessSlider.value=this.brightness,this.contrastSlider.value=this.contrast,this.saturationSlider.value=this.saturation,this.grayscaleSlider.value=this.grayscale,this.updateFilters()}},{key:"resetFilters",value:function(){this.applyPreset("normal")}}],n&&t(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n}();function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,s(i.key),i)}}function s(e){var t=function(e){if("object"!=o(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==o(t)?t:t+""}var a=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.image=t,this.imageWrapper=n,this.isEditMode=!1,this.currentTool="select",this.selectedElement=null,this.selectedElements=[],this.elements=[],this.nextElementId=1,this.toggleEditModeBtn=document.getElementById("toggleEditMode"),this.editControls=document.getElementById("editControls"),this.editCanvas=document.getElementById("editCanvas"),this.addTextBtn=document.getElementById("addText"),this.addCircleBtn=document.getElementById("addCircle"),this.addRectangleBtn=document.getElementById("addRectangle"),this.selectToolBtn=document.getElementById("selectTool"),this.deleteSelectedBtn=document.getElementById("deleteSelected"),this.editProperties=document.getElementById("editProperties"),this.shapeColor=document.getElementById("shapeColor"),this.borderColor=document.getElementById("borderColor"),this.fillOpacity=document.getElementById("fillOpacity"),this.borderOpacity=document.getElementById("borderOpacity"),this.fillOpacityValue=document.getElementById("fillOpacityValue"),this.borderOpacityValue=document.getElementById("borderOpacityValue"),this.shapeSize=document.getElementById("shapeSize"),this.textInput=document.getElementById("textInput"),this.fontSize=document.getElementById("fontSize"),this.fontSizeInput=document.getElementById("fontSizeInput"),this.selectionInfo=document.getElementById("selectionInfo")},t=[{key:"setupEventListeners",value:function(){var e=this;console.log("Setting up edit mode event listeners..."),console.log("addTextBtn:",this.addTextBtn),console.log("addCircleBtn:",this.addCircleBtn),console.log("addRectangleBtn:",this.addRectangleBtn),console.log("editCanvas:",this.editCanvas),this.addTextBtn&&this.addTextBtn.addEventListener("click",function(){console.log("Text button clicked"),e.setTool("text"),e.onLogMessage&&e.onLogMessage("Text tool selected")}),this.addCircleBtn&&this.addCircleBtn.addEventListener("click",function(){console.log("Circle button clicked"),e.setTool("circle"),e.onLogMessage&&e.onLogMessage("Circle tool selected")}),this.addRectangleBtn&&this.addRectangleBtn.addEventListener("click",function(){console.log("Rectangle button clicked"),e.setTool("rectangle"),e.onLogMessage&&e.onLogMessage("Rectangle tool selected")}),this.selectToolBtn&&this.selectToolBtn.addEventListener("click",function(){console.log("Select button clicked"),e.setTool("select"),e.onLogMessage&&e.onLogMessage("Select tool selected")}),this.deleteSelectedBtn&&this.deleteSelectedBtn.addEventListener("click",function(){return e.deleteSelectedElement()}),this.shapeColor&&this.shapeColor.addEventListener("change",function(){return e.updateSelectedElement()}),this.borderColor&&this.borderColor.addEventListener("change",function(){return e.updateSelectedElement()}),this.fillOpacity&&this.fillOpacity.addEventListener("input",function(t){e.fillOpacityValue&&(e.fillOpacityValue.textContent=t.target.value+"%"),e.updateSelectedElement()}),this.borderOpacity&&this.borderOpacity.addEventListener("input",function(t){e.borderOpacityValue&&(e.borderOpacityValue.textContent=t.target.value+"%"),e.updateSelectedElement()}),this.shapeSize&&this.shapeSize.addEventListener("input",function(){return e.updateSelectedElement()}),this.textInput&&this.textInput.addEventListener("input",function(){return e.updateSelectedElement()}),this.fontSize&&this.fontSize.addEventListener("input",function(t){e.fontSizeInput&&(e.fontSizeInput.value=t.target.value),e.updateSelectedElement()}),this.fontSizeInput&&this.fontSizeInput.addEventListener("input",function(t){e.fontSize&&(e.fontSize.value=t.target.value),e.updateSelectedElement()}),this.editCanvas&&(this.editCanvas.addEventListener("click",function(t){return e.handleCanvasClick(t)}),console.log("Canvas click listener added")),document.addEventListener("keydown",function(t){return e.handleKeyDown(t)}),console.log("Edit mode event listeners setup complete")}},{key:"setupEditCanvas",value:function(){var e=this;setTimeout(function(){var t=e.image.getBoundingClientRect(),n=e.imageWrapper.getBoundingClientRect();console.log("Image rect:",t),console.log("Wrapper rect:",n),console.log("Image natural size:",e.image.naturalWidth,"x",e.image.naturalHeight),console.log("Image offset size:",e.image.offsetWidth,"x",e.image.offsetHeight);var i=t.width,o=t.height;e.editCanvas.style.width=i+"px",e.editCanvas.style.height=o+"px",e.editCanvas.style.left=t.left-n.left+"px",e.editCanvas.style.top=t.top-n.top+"px",vscode.postMessage({command:"log",text:"Canvas setup: ".concat(i,"x").concat(o," at (").concat(t.left-n.left,", ").concat(t.top-n.top,")")}),e.elements.forEach(function(t){var n=document.querySelector('[data-element-id="'.concat(t.id,'"]'));n&&n.remove(),e.renderElement(t)}),e.editCanvas.style.pointerEvents="auto",e.editCanvas.style.zIndex="9999",console.log("Canvas final setup:",{styleWidth:e.editCanvas.style.width,styleHeight:e.editCanvas.style.height,styleLeft:e.editCanvas.style.left,styleTop:e.editCanvas.style.top})},100)}},{key:"setTool",value:function(e){switch(console.log("Setting tool to:",e),this.currentTool=e,[this.addTextBtn,this.addCircleBtn,this.addRectangleBtn,this.selectToolBtn].forEach(function(e){e&&e.classList.remove("active")}),e){case"text":this.addTextBtn&&this.addTextBtn.classList.add("active"),this.editCanvas&&this.editCanvas.classList.remove("select-mode");break;case"circle":this.addCircleBtn&&this.addCircleBtn.classList.add("active"),this.editCanvas&&this.editCanvas.classList.remove("select-mode");break;case"rectangle":this.addRectangleBtn&&this.addRectangleBtn.classList.add("active"),this.editCanvas&&this.editCanvas.classList.remove("select-mode");break;case"select":this.selectToolBtn&&this.selectToolBtn.classList.add("active"),this.editCanvas&&this.editCanvas.classList.add("select-mode")}this.editProperties&&(this.editProperties.style.display="select"===e&&this.selectedElement?"flex":"none"),console.log("Tool set to:",this.currentTool)}},{key:"handleCanvasClick",value:function(e){if(console.log("Canvas clicked!"),console.log("isEditMode:",this.isEditMode),console.log("currentTool:",this.currentTool),!this.isEditMode)return console.log("Edit mode not active"),void(this.onLogMessage&&this.onLogMessage("Edit mode not active"));var t=this.editCanvas.getBoundingClientRect(),n=this.image.getBoundingClientRect();console.log("Canvas rect:",t),console.log("Image rect:",n);var i=e.clientX-t.left,o=e.clientY-t.top;i<0||i>t.width||o<0||o>t.height?console.log("Click outside canvas bounds"):(console.log("Canvas click: (".concat(i,", ").concat(o,"), tool: ").concat(this.currentTool)),this.onLogMessage&&this.onLogMessage("Canvas click: (".concat(i,", ").concat(o,"), tool: ").concat(this.currentTool,", canvas rect: ").concat(t.left,",").concat(t.top)),"select"===this.currentTool?this.selectElementAt(i,o,e.metaKey||e.ctrlKey):this.addElementAt(i,o))}},{key:"addElementAt",value:function(e,t){console.log("addElementAt called with:",e,t,this.currentTool);var n={id:this.nextElementId++,type:this.currentTool,x:e,y:t,color:this.shapeColor&&this.shapeColor.value||"#ff0000",borderColor:this.borderColor&&this.borderColor.value||"#000000",fillOpacity:this.fillOpacity?parseInt(this.fillOpacity.value):100,borderOpacity:this.borderOpacity?parseInt(this.borderOpacity.value):100,size:this.shapeSize&&parseInt(this.shapeSize.value)||100,text:this.textInput&&this.textInput.value||"Text",fontSize:this.fontSize&&parseInt(this.fontSize.value)||24};if(console.log("Created element:",n),this.elements.push(n),console.log("Elements array:",this.elements),this.renderElement(n),this.selectedElement=n,"select"===this.currentTool){var i=document.querySelector('[data-element-id="'.concat(n.id,'"]'));i&&i.classList.add("selected"),this.updatePropertiesPanel()}this.onLogMessage&&this.onLogMessage("Added ".concat(this.currentTool," element at (").concat(e,", ").concat(t,"), total elements: ").concat(this.elements.length,", color: ").concat(n.color,", size: ").concat(n.size))}},{key:"selectElementAt",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];console.log("selectElementAt called with:",e,t,"multiSelect:",n);for(var i=null,o=this.elements.length-1;o>=0;o--){var l=this.elements[o],s=document.querySelector('[data-element-id="'.concat(l.id,'"]'));if(s){var a=s.getBoundingClientRect(),r=this.editCanvas.getBoundingClientRect(),c=e>=a.left-r.left&&e<=a.right-r.left&&t>=a.top-r.top&&t<=a.bottom-r.top;if(console.log("Element ".concat(l.id," hit test:"),c),c){i=l;break}}}i?(n?this.selectedElements.some(function(e){return e.id===i.id})?this.deselectElement(i):(this.selectedElements.push(i),this.selectElement(i)):(this.clearAllSelections(),this.selectedElements=[i],this.selectElement(i)),this.bringElementToFront(i),this.updatePropertiesPanel(),this.onLogMessage&&this.onLogMessage("Selected ".concat(i.type," element (").concat(this.selectedElements.length," total selected)"))):n||(this.clearAllSelections(),this.editProperties&&(this.editProperties.style.display="none"))}},{key:"selectElement",value:function(e){var t=document.querySelector('[data-element-id="'.concat(e.id,'"]'));t&&(t.classList.add("selected"),"rectangle"===e.type&&t.querySelectorAll(".resize-handle").forEach(function(e){return e.style.display="block"})),this.updateSelectionInfo()}},{key:"deselectElement",value:function(e){var t=document.querySelector('[data-element-id="'.concat(e.id,'"]'));t&&(t.classList.remove("selected"),t.querySelectorAll(".resize-handle").forEach(function(e){return e.style.display="none"})),this.selectedElements=this.selectedElements.filter(function(t){return t.id!==e.id}),this.updateSelectionInfo()}},{key:"clearAllSelections",value:function(){var e=this;this.selectedElements.forEach(function(t){e.deselectElement(t)}),this.selectedElements=[],this.selectedElement=null,this.updateSelectionInfo()}},{key:"updateSelectionInfo",value:function(){if(this.selectionInfo){var e=this.selectedElements.length;e>0?(this.selectionInfo.textContent="".concat(e," selected"),this.selectionInfo.style.display="inline"):this.selectionInfo.style.display="none"}}},{key:"renderElement",value:function(e){var t;if(console.log("renderElement called with:",e),"text"===e.type){console.log("Creating text element"),(t=document.createElement("div")).className="text-element",t.textContent=e.text,t.style.fontSize=e.fontSize+"px";var n=(void 0!==e.fillOpacity?e.fillOpacity:100)/100,i=this.hexToRgba(e.color,n);t.style.color=i,t.style.position="absolute",t.style.left=e.x+"px",t.style.top=e.y+"px",t.style.transform="translate(-50%, -50%)",t.style.zIndex="10000",t.style.pointerEvents="auto",t.style.cursor="move",t.style.userSelect="none"}else if(console.log("Creating shape element:",e.type),(t=document.createElement("div")).className="shape-element",t.style.position="absolute",t.style.left=e.x+"px",t.style.top=e.y+"px",t.style.zIndex="10000",t.style.pointerEvents="auto",t.style.cursor="move",t.style.userSelect="none","circle"===e.type){t.style.width=e.size+"px",t.style.height=e.size+"px",t.style.borderRadius="50%";var o=(void 0!==e.fillOpacity?e.fillOpacity:100)/100,l=this.hexToRgba(e.color,o);t.style.backgroundColor=l;var s=(void 0!==e.borderOpacity?e.borderOpacity:100)/100,a=this.hexToRgba(e.borderColor||"#000000",s);t.style.borderColor=a,t.style.transform="translate(-50%, -50%)"}else if("rectangle"===e.type){t.style.width=e.size+"px",t.style.height=e.size+"px";var r=(void 0!==e.fillOpacity?e.fillOpacity:100)/100,c=this.hexToRgba(e.color,r);t.style.backgroundColor=c;var d=(void 0!==e.borderOpacity?e.borderOpacity:100)/100,u=this.hexToRgba(e.borderColor||"#000000",d);t.style.borderColor=u,t.style.transform="translate(-50%, -50%)",this.addResizeHandles(t,e)}t.setAttribute("data-element-id",e.id),console.log("Element created:",t),console.log("Element styles:",t.style.cssText),this.makeElementDraggable(t,e),console.log("Adding element to canvas:",this.editCanvas),this.editCanvas.appendChild(t),console.log("Canvas children count:",this.editCanvas.children.length),console.log("Canvas innerHTML length:",this.editCanvas.innerHTML.length),this.onLogMessage&&this.onLogMessage("Rendered ".concat(e.type," element with ID ").concat(e.id," at (").concat(e.x,", ").concat(e.y,")"))}},{key:"makeElementDraggable",value:function(e,t){var n,i,o=this,l=!1,s=[];e.addEventListener("mousedown",function(e){"select"===o.currentTool&&(l=!0,n=e.clientX-t.x,i=e.clientY-t.y,o.selectedElements.length>1&&(s=o.selectedElements.map(function(e){return{id:e.id,x:e.x,y:e.y}})),e.stopPropagation())}),document.addEventListener("mousemove",function(a){if(l&&o.selectedElements.some(function(e){return e.id===t.id})){var r=a.clientX-n-t.x,c=a.clientY-i-t.y;o.selectedElements.length>1?o.selectedElements.forEach(function(e){var t=s.find(function(t){return t.id===e.id});if(t){e.x=t.x+r,e.y=t.y+c;var n=document.querySelector('[data-element-id="'.concat(e.id,'"]'));n&&(n.style.left=e.x+"px",n.style.top=e.y+"px")}}):(t.x=a.clientX-n,t.y=a.clientY-i,e.style.left=t.x+"px",e.style.top=t.y+"px")}}),document.addEventListener("mouseup",function(){l=!1,s=[]}),"text"===t.type&&e.addEventListener("dblclick",function(n){"select"===o.currentTool&&(o.makeTextEditable(e,t),n.stopPropagation())})}},{key:"makeTextEditable",value:function(e,t){e.classList.add("editing");var n=document.createElement("input");n.type="text",n.value=t.text,n.style.fontSize=t.fontSize+"px",n.style.color=t.color,n.addEventListener("blur",function(){t.text=n.value,e.textContent=n.value,e.classList.remove("editing"),e.removeChild(n)}),n.addEventListener("keydown",function(e){"Enter"===e.key&&n.blur()}),e.textContent="",e.appendChild(n),n.focus(),n.select()}},{key:"updatePropertiesPanel",value:function(){var e=this;if(console.log("updatePropertiesPanel called"),console.log("selectedElements:",this.selectedElements),console.log("editProperties:",this.editProperties),0===this.selectedElements.length||!this.editProperties)return console.log("No selected elements or editProperties not found"),void(this.editProperties.style.display="none");var t=this.selectedElements[0],n={color:t.color,borderColor:t.borderColor||"#000000",fillOpacity:void 0!==t.fillOpacity?t.fillOpacity:100,borderOpacity:void 0!==t.borderOpacity?t.borderOpacity:100,size:t.size,text:t.text||"",fontSize:t.fontSize||24};if(this.selectedElements.length>1){var i=this.selectedElements.map(function(e){return e.color}),o=this.selectedElements.map(function(e){return e.borderColor||"#000000"}),l=this.selectedElements.map(function(e){return void 0!==e.fillOpacity?e.fillOpacity:100}),s=this.selectedElements.map(function(e){return void 0!==e.borderOpacity?e.borderOpacity:100}),a=this.selectedElements.map(function(e){return e.size}),r=this.selectedElements.map(function(e){return e.text||""}),c=this.selectedElements.map(function(e){return e.fontSize||24}),d=i.every(function(e){return e===i[0]}),u=o.every(function(e){return e===o[0]}),h=l.every(function(e){return e===l[0]}),p=s.every(function(e){return e===s[0]}),m=a.every(function(e){return e===a[0]}),f=r.every(function(e){return e===r[0]}),y=c.every(function(e){return e===c[0]});n={color:d?i[0]:"mixed",borderColor:u?o[0]:"mixed",fillOpacity:h?l[0]:Math.round(l.reduce(function(e,t){return e+t},0)/l.length),borderOpacity:p?s[0]:Math.round(s.reduce(function(e,t){return e+t},0)/s.length),size:m?a[0]:Math.round(a.reduce(function(e,t){return e+t},0)/a.length),text:f?r[0]:"mixed",fontSize:y?c[0]:Math.round(c.reduce(function(e,t){return e+t},0)/c.length)}}console.log("Updating properties panel with:",n),this.editProperties.querySelectorAll(".property-group").forEach(function(t){var n=t.querySelector('input[type="color"][id="shapeColor"]'),i=t.querySelector('input[type="color"][id="borderColor"]'),o=t.querySelector('input[type="range"][id="borderOpacity"]'),l=t.querySelector('input[type="text"]'),s=t.querySelector('input[type="range"][id="fontSize"]');if(n)t.style.display="flex";else if(i||o){var a=e.selectedElements.some(function(e){return"text"===e.type}),r=e.selectedElements.some(function(e){return"text"!==e.type});t.style.display=r||a&&r?"flex":"none"}else if(l||s){var c=e.selectedElements.some(function(e){return"text"===e.type});t.style.display=c?"flex":"none"}}),this.shapeColor&&(this.shapeColor.value="mixed"===n.color?"#ff0000":n.color,console.log("Set shapeColor to:",this.shapeColor.value)),this.borderColor&&(this.borderColor.value="mixed"===n.borderColor?"#000000":n.borderColor,console.log("Set borderColor to:",this.borderColor.value)),this.fillOpacity&&(this.fillOpacity.value=n.fillOpacity,this.fillOpacityValue&&(this.fillOpacityValue.textContent=n.fillOpacity+"%"),console.log("Set fillOpacity to:",this.fillOpacity.value)),this.borderOpacity&&(this.borderOpacity.value=n.borderOpacity,this.borderOpacityValue&&(this.borderOpacityValue.textContent=n.borderOpacity+"%"),console.log("Set borderOpacity to:",this.borderOpacity.value)),this.shapeSize&&(this.shapeSize.value=n.size,console.log("Set shapeSize to:",this.shapeSize.value)),this.textInput&&(this.textInput.value="mixed"===n.text?"":n.text,console.log("Set textInput to:",this.textInput.value)),this.fontSize&&(this.fontSize.value=n.fontSize,this.fontSizeInput&&(this.fontSizeInput.value=n.fontSize),console.log("Set fontSize to:",this.fontSize.value)),this.editProperties.style.display="flex",console.log("Properties panel displayed"),this.onLogMessage&&this.onLogMessage("Properties panel updated for ".concat(this.selectedElements.length," element(s)"))}},{key:"deleteSelectedElement",value:function(){var e=this;if(0!==this.selectedElements.length){this.selectedElements.forEach(function(t){var n=document.querySelector('[data-element-id="'.concat(t.id,'"]'));n&&e.editCanvas.removeChild(n),e.elements=e.elements.filter(function(e){return e.id!==t.id})});var t=this.selectedElements.length;this.selectedElements=[],this.selectedElement=null,this.editProperties.style.display="none",this.updateSelectionInfo(),this.onLogMessage&&this.onLogMessage("".concat(t," element(s) deleted"))}}},{key:"updateSelectedElement",value:function(){var e=this;if(console.log("updateSelectedElement called"),console.log("selectedElements:",this.selectedElements),0!==this.selectedElements.length){var t=this.selectedElements[0];console.log("Before update - color:",t.color),console.log("shapeColor value:",this.shapeColor?this.shapeColor.value:"shapeColor not found"),this.selectedElements.forEach(function(t){var n=!1;e.shapeSize&&parseInt(e.shapeSize.value)!==t.size&&(n=!0),e.shapeColor&&(t.color=e.handleTransparentColor(e.shapeColor.value),console.log("Updated color to:",t.color)),e.borderColor&&(t.borderColor=e.handleTransparentColor(e.borderColor.value),console.log("Updated border color to:",t.borderColor)),e.fillOpacity&&(t.fillOpacity=parseInt(e.fillOpacity.value),console.log("Updated fill opacity to:",t.fillOpacity)),e.borderOpacity&&(t.borderOpacity=parseInt(e.borderOpacity.value),console.log("Updated border opacity to:",t.borderOpacity)),e.shapeSize&&(t.size=parseInt(e.shapeSize.value)),"text"===t.type&&(e.textInput&&(t.text=e.textInput.value),e.fontSize&&(t.fontSize=parseInt(e.fontSize.value)),e.fontSizeInput&&(t.fontSize=parseInt(e.fontSizeInput.value))),console.log("After update - element:",t);var i=document.querySelector('[data-element-id="'.concat(t.id,'"]'));if(i)n?e.updateElementStylesWithSize(i,t):e.updateElementStyles(i,t);else{console.log("Element not found, re-rendering"),e.renderElement(t);var o=document.querySelector('[data-element-id="'.concat(t.id,'"]'));o&&o.classList.add("selected")}}),this.onLogMessage&&this.onLogMessage("Updated ".concat(this.selectedElements.length," element(s) color to ").concat(this.shapeColor?this.shapeColor.value:"N/A"))}else console.log("No selected elements")}},{key:"updateElementStyles",value:function(e,t){if(console.log("updateElementStyles called for:",t.type),"text"===t.type){e.textContent=t.text,e.style.fontSize=t.fontSize+"px";var n=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,i=this.hexToRgba(t.color,n);e.style.color=i}else if("circle"===t.type){var o=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,l=this.hexToRgba(t.color,o);e.style.backgroundColor=l;var s=(void 0!==t.borderOpacity?t.borderOpacity:100)/100,a=this.hexToRgba(t.borderColor||"#000000",s);e.style.borderColor=a}else if("rectangle"===t.type){var r=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,c=this.hexToRgba(t.color,r);e.style.backgroundColor=c;var d=(void 0!==t.borderOpacity?t.borderOpacity:100)/100,u=this.hexToRgba(t.borderColor||"#000000",d);e.style.borderColor=u}console.log("Element styles updated")}},{key:"updateElementStylesWithSize",value:function(e,t){if(console.log("updateElementStylesWithSize called for:",t.type),"text"===t.type){e.textContent=t.text,e.style.fontSize=t.fontSize+"px";var n=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,i=this.hexToRgba(t.color,n);e.style.color=i}else if("circle"===t.type){e.style.width=t.size+"px",e.style.height=t.size+"px",e.style.borderRadius="50%";var o=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,l=this.hexToRgba(t.color,o);e.style.backgroundColor=l;var s=(void 0!==t.borderOpacity?t.borderOpacity:100)/100,a=this.hexToRgba(t.borderColor||"#000000",s);e.style.borderColor=a}else if("rectangle"===t.type){e.style.width=t.size+"px",e.style.height=t.size+"px";var r=(void 0!==t.fillOpacity?t.fillOpacity:100)/100,c=this.hexToRgba(t.color,r);e.style.backgroundColor=c;var d=(void 0!==t.borderOpacity?t.borderOpacity:100)/100,u=this.hexToRgba(t.borderColor||"#000000",d);e.style.borderColor=u}console.log("Element styles with size updated")}},{key:"addResizeHandles",value:function(e,t){var n=this;["top-left","top-right","bottom-left","bottom-right"].forEach(function(i){var o=document.createElement("div");o.className="resize-handle ".concat(i),o.setAttribute("data-handle-type",i),o.style.display="none",e.appendChild(o),n.makeHandleResizable(o,e,t,i)})}},{key:"makeHandleResizable",value:function(e,t,n,i){var o,l,s,a,r,c,d=this,u=!1;e.addEventListener("mousedown",function(e){"select"===d.currentTool&&(u=!0,o=e.clientX,l=e.clientY,s=n.size,a=n.size,r=n.x,c=n.y,e.stopPropagation())}),document.addEventListener("mousemove",function(e){if(u){var d=e.clientX-o,h=e.clientY-l,p=s,m=a,f=r,y=c;switch(i){case"bottom-right":p=Math.max(20,s+d),m=Math.max(20,a+h);break;case"bottom-left":p=Math.max(20,s-d),m=Math.max(20,a+h),f=r+(s-p);break;case"top-right":p=Math.max(20,s+d),m=Math.max(20,a-h),y=c+(a-m);break;case"top-left":p=Math.max(20,s-d),m=Math.max(20,a-h),f=r+(s-p),y=c+(a-m)}n.size=p,n.x=f,n.y=y,t.style.width=p+"px",t.style.height=m+"px",t.style.left=f+"px",t.style.top=y+"px"}}),document.addEventListener("mouseup",function(){u=!1})}},{key:"bringElementToFront",value:function(e){var t=this.elements.indexOf(e);t>-1&&this.elements.splice(t,1),this.elements.push(e),this.elements.forEach(function(e,t){var n=document.querySelector('[data-element-id="'.concat(e.id,'"]'));n&&(n.style.zIndex=1e4+t)}),console.log("Element brought to front:",e.id),this.onLogMessage&&this.onLogMessage("Element ".concat(e.id," brought to front"))}},{key:"enableEditMode",value:function(){this.isEditMode=!0,this.editCanvas.classList.add("active"),this.elements=[],this.nextElementId=1,this.editCanvas.innerHTML="",this.setupEditCanvas(),this.setTool("select")}},{key:"disableEditMode",value:function(){this.isEditMode=!1,this.editCanvas.classList.remove("active"),this.selectedElement=null,this.selectedElements=[],this.editProperties&&(this.editProperties.style.display="none")}},{key:"handleTransparentColor",value:function(e){return"#00000000"===e||"rgba(0,0,0,0)"===e?"transparent":e}},{key:"handleKeyDown",value:function(e){this.isEditMode&&("Delete"!==e.key&&"Backspace"!==e.key||(e.preventDefault(),this.deleteSelectedElement()),"Escape"===e.key&&(this.clearAllSelections(),this.editProperties&&(this.editProperties.style.display="none")))}},{key:"hexToRgba",value:function(e,t){e=e.replace("#","");var n=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16),o=parseInt(e.substr(4,2),16);return"rgba(".concat(n,", ").concat(i,", ").concat(o,", ").concat(t,")")}}],t&&l(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,d(i.key),i)}}function d(e){var t=function(e){if("object"!=r(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==r(t)?t:t+""}var u=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)},(t=[{key:"handleTransparentColor",value:function(e){return"#00000000"===e||"rgba(0,0,0,0)"===e?"transparent":e}},{key:"hexToRgba",value:function(e,t){e=e.replace("#","");var n=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16),o=parseInt(e.substr(4,2),16);return"rgba(".concat(n,", ").concat(i,", ").concat(o,", ").concat(t,")")}},{key:"validateFilename",value:function(e,t){return e.toLowerCase().endsWith(t.toLowerCase())?/[<>:"/\\|?*]/.test(e)?"Filename contains invalid characters":null:"Filename should end with ".concat(t)}},{key:"generateDefaultFilename",value:function(e){var t=e.substring(0,e.lastIndexOf(".")),n=e.substring(e.lastIndexOf(".")),i=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);return"".concat(t,"_saved_").concat(i).concat(n)}},{key:"getWorkspacePath",value:function(){return"{{workspacePath}}"}},{key:"getFileName",value:function(){return"{{fileName}}"}},{key:"getFileSize",value:function(){return"{{fileSize}}"}}])&&c(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,m(i.key),i)}}function m(e){var t=function(e){if("object"!=h(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=h(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==h(t)?t:t+""}var f=function(){return e=function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.image=t,this.vscode=n,this.imageFilters=i,this.filenameModal=document.getElementById("filenameModal"),this.filenameInput=document.getElementById("filenameInput"),this.cancelSaveBtn=document.getElementById("cancelSave"),this.confirmSaveBtn=document.getElementById("confirmSave"),this.currentPathSpan=document.getElementById("currentPath"),this.setupModalEventListeners()},t=[{key:"setupModalEventListeners",value:function(){var e=this;this.cancelSaveBtn.addEventListener("click",function(){e.filenameModal.style.display="none",e.filenameInput.value=""}),this.confirmSaveBtn.addEventListener("click",function(){var t=e.filenameInput.value.trim();t&&(e.filenameModal.style.display="none",e.saveFilteredImageWithName(t))}),this.filenameModal.addEventListener("click",function(t){t.target===e.filenameModal&&(e.filenameModal.style.display="none",e.filenameInput.value="")}),this.filenameInput.addEventListener("keydown",function(t){"Enter"===t.key?e.confirmSaveBtn.click():"Escape"===t.key&&e.cancelSaveBtn.click()}),this.filenameInput.addEventListener("input",function(){return e.updateSavePath()})}},{key:"saveFilteredImage",value:function(e,t,n,i,o,l){var s="{{fileName}}",a=s.substring(0,s.lastIndexOf(".")),r=s.substring(s.lastIndexOf(".")),c=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19),d="".concat(a,"_saved_").concat(c).concat(r);this.currentRotation=n,this.isFlippedHorizontal=i,this.isFlippedVertical=o,this.filterString=l,this.filenameInput.value=d,this.filenameInput.focus(),this.filenameInput.select(),this.filenameModal.style.display="flex",this.updateSavePath()}},{key:"updateSavePath",value:function(){var e=this.filenameInput.value.trim()||"filename.png",t="{{workspacePath}}";this.currentPathSpan.textContent=t?"".concat(t,"/").concat(e):"[Workspace folder]/".concat(e)}},{key:"updatePathFromVSCode",value:function(e){this.currentPathSpan.textContent=e}},{key:"saveFilteredImageWithName",value:function(e){var t=this,n="{{fileName}}",i=n.substring(n.lastIndexOf("."));if(e.toLowerCase().endsWith(i.toLowerCase()))if(/[<>:"/\\|?*]/.test(e))alert("Filename contains invalid characters");else{var o=document.createElement("canvas"),l=o.getContext("2d");o.width=this.image.naturalWidth,o.height=this.image.naturalHeight,l.filter=this.filterString||(this.imageFilters?this.imageFilters.getFilterString():""),l.save(),l.translate(o.width/2,o.height/2),l.rotate((this.currentRotation||0)*Math.PI/180);var s=this.isFlippedHorizontal?-1:1,a=this.isFlippedVertical?-1:1;l.scale(s,a),l.drawImage(this.image,-this.image.naturalWidth/2,-this.image.naturalHeight/2,this.image.naturalWidth,this.image.naturalHeight),l.restore(),o.toBlob(function(n){if(n){var i=new FileReader;i.onload=function(){var n=i.result.split(",")[1];t.vscode.postMessage({command:"saveFilteredImage",fileName:e,imageData:n}),t.vscode.postMessage({command:"log",text:"Filtered image saved as ".concat(e)})},i.readAsDataURL(n)}else t.vscode.postMessage({command:"error",text:"Failed to create filtered image"})},"image/png",.9)}else alert("Filename should end with ".concat(i))}},{key:"saveEditedImage",value:function(e,t,n,i,o,l,s){var a=this,r=document.createElement("canvas"),c=r.getContext("2d");r.width=t,r.height=n,c.filter=s,c.save(),c.translate(r.width/2,r.height/2),c.rotate(i*Math.PI/180);var d=o?-1:1,u=l?-1:1;c.scale(d,u),c.drawImage(this.image,-t/2,-n/2,t,n),c.restore();var h=document.getElementById("editCanvas").getBoundingClientRect(),p=r.width/h.width,m=r.height/h.height;e.forEach(function(e){c.save(),c.translate(e.x*p,e.y*m),"text"===e.type?(c.font="".concat(e.fontSize*p,"px Arial"),c.fillStyle=e.color,c.textAlign="center",c.textBaseline="middle",c.fillText(e.text,0,0)):"circle"===e.type?(c.fillStyle=e.color,c.beginPath(),c.arc(0,0,e.size*p/2,0,2*Math.PI),c.fill()):"rectangle"===e.type&&(c.fillStyle=e.color,c.fillRect(-e.size*p/2,-e.size*m/2,e.size*p,e.size*m)),c.restore()}),r.toBlob(function(e){if(e){var t=new FileReader;t.onload=function(){var e=t.result.split(",")[1],n="{{fileName}}".replace(/\.[^/.]+$/,"_saved.png");a.vscode.postMessage({command:"saveFilteredImage",fileName:n,imageData:e}),a.vscode.postMessage({command:"log",text:"Edited image saved as ".concat(n)})},t.readAsDataURL(e)}else a.vscode.postMessage({command:"error",text:"Failed to create edited image"})},"image/png",.9)}}],t&&p(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();console.log("Image viewer script loading...");var y=acquireVsCodeApi();console.log("VSCode API acquired");var g=100,v=0,E=!1,b=!1,S=0,x=0,C="",I="",k=document.getElementById("image"),L=document.getElementById("imageWrapper"),B=document.getElementById("loading"),z=document.getElementById("error"),O=document.getElementById("fileInfo"),M=document.getElementById("sizeInfo"),w=document.getElementById("formatInfo"),T=document.getElementById("fileSizeInfo"),P=document.getElementById("zoomIn"),R=document.getElementById("zoomOut"),F=document.getElementById("rotate"),A=document.getElementById("flipHorizontal"),D=document.getElementById("flipVertical"),V=document.getElementById("reset"),q=document.getElementById("fitToScreen"),W=document.getElementById("saveFiltered"),N=new i(k),H=new a(k,L),j=(new u,new f(k,y,N));function U(){K()}function K(){var e=g/100,t=v,n=E?-1:1,i=b?-1:1;k.style.transform="scale(".concat(e*n,", ").concat(e*i,") rotate(").concat(t,"deg)"),H.isEditMode&&H.setupEditCanvas()}function Y(){M.textContent="".concat(S,"Ã—").concat(x),w.textContent=C,T.textContent=I}function X(){var e=L.parentElement,t=e.clientWidth-40,n=e.clientHeight-40,i=t/S,o=n/x,l=Math.min(i,o,1);g=Math.round(100*l),U(),Y()}H.onLogMessage=function(e){y.postMessage({command:"log",text:e})},document.addEventListener("DOMContentLoaded",function(){console.log("DOM Content Loaded"),console.log("Initializing image viewer..."),function(){P.addEventListener("click",function(){g=Math.min(500,g+25),U()}),R.addEventListener("click",function(){g=Math.max(10,g-25),U()}),L.addEventListener("wheel",function(e){e.preventDefault();var t=e.deltaY>0?-1:1,n=e.ctrlKey?10:25;g=Math.max(10,Math.min(500,g+t*n)),U()}),F.addEventListener("click",function(){v=(v+90)%360,K()}),A.addEventListener("click",function(){E=!E,K()}),D.addEventListener("click",function(){b=!b,K()}),V.addEventListener("click",function(){g=100,v=0,E=!1,b=!1,U(),Y(),N.resetFilters()}),q.addEventListener("click",function(){X()}),W.addEventListener("click",function(){H.elements.length>0?j.saveEditedImage(H.elements,S,x,v,E,b,N.getFilterString()):j.saveFilteredImage(S,x,v,E,b,N.getFilterString())});var e=document.getElementById("toggleEditMode"),t=document.getElementById("editControls");e.addEventListener("click",function(){var n="none"!==t.style.display;t.style.display=n?"none":"flex",e.classList.toggle("active",!n),n?(H.disableEditMode(),y.postMessage({command:"log",text:"Edit mode disabled"})):(H.enableEditMode(),y.postMessage({command:"log",text:"Edit mode enabled"}))}),N.setupEventListeners(),document.addEventListener("keydown",function(e){switch(e.key){case"+":case"=":e.preventDefault(),P.click();break;case"-":e.preventDefault(),R.click();break;case"0":e.preventDefault(),V.click();break;case"f":e.preventDefault(),q.click();break;case"ArrowLeft":case"ArrowRight":e.preventDefault(),F.click();break;case"s":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),W.click())}})}(),H.setupEventListeners(),console.log("Event listeners setup complete"),k.onload=function(){S=k.naturalWidth,x=k.naturalHeight;var e="{{fileName}}".split(".").pop().toUpperCase();C=e,I="{{fileSize}}",B.style.display="none",L.style.display="block",O.style.display="flex",Y(),X(),setTimeout(function(){H.setupEditCanvas()},200),y.postMessage({command:"log",text:"Image loaded successfully"})},k.onerror=function(){B.style.display="none",z.style.display="block",z.textContent="Error loading image file",y.postMessage({command:"error",text:"Failed to load image"})}}),y.postMessage({command:"log",text:"Image viewer initialized"}),ImageViewer={}})();